{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Lab Work · {{ v.patient.full_name }}</h3>
  <a class="btn btn-outline-secondary" href="/dashboard/lab/"><i class="bi bi-arrow-left"></i> Back</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="mb-2 text-muted small">Logged: {{ v.timestamp|date:'Y-m-d H:i' }}{% if v.queue_number %} · Queue: {{ v.queue_number }}{% endif %}</div>
    <div class="mb-1"><strong>Requested Tests:</strong> {{ v.lab_tests|default:'-' }}</div>
    <div class="mb-3"><strong>Department:</strong> {{ v.lab_test_type|default:'Not Selected' }}</div>
    <form method="post" class="row g-3">
      {% csrf_token %}
      <div class="col-md-6 result-field" data-index="1">
        <label class="form-label" id="label_r1">Result 1</label>
        <input class="form-control" name="result_1" value="{{ prefill.result_1 }}">
      </div>
      <div class="col-md-6 result-field" data-index="2">
        <label class="form-label" id="label_r2">Result 2</label>
        <input class="form-control" name="result_2" value="{{ prefill.result_2 }}">
      </div>
      <div class="col-md-6 result-field" data-index="3">
        <label class="form-label" id="label_r3">Result 3</label>
        <input class="form-control" name="result_3" value="{{ prefill.result_3 }}">
      </div>
      <div class="col-md-6 result-field" data-index="4">
        <label class="form-label" id="label_r4">Result 4</label>
        <input class="form-control" name="result_4" value="{{ prefill.result_4 }}">
      </div>
      <div class="col-md-6 result-field" data-index="5">
        <label class="form-label" id="label_r5">Result 5</label>
        <input class="form-control" name="result_5" value="{{ prefill.result_5 }}">
      </div>
      <div class="col-12">
        <label class="form-label" id="label_interp">Interpretation</label>
        <input class="form-control" name="interpretation" value="{{ prefill.interpretation }}">
      </div>
      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary" name="save_only" value="1" type="submit"><i class="bi bi-save me-1"></i>Save</button>
        <button class="btn btn-success" name="complete" value="1" type="submit"><i class="bi bi-check2-circle me-1"></i>Mark as Done</button>
        <button class="btn btn-warning" name="mark_not_done" value="1" type="submit"><i class="bi bi-x-circle me-1"></i>Mark as Not Done</button>
      </div>
    </form>
  </div>
</div>

<!-- Dynamic field labels per department -->

<script>
(function(){
  const labelSets = {
    'Hematology': ['Hemoglobin','Hematocrit','WBC Count','RBC Count','Platelet Count'],
    'Clinical Microscopy': ['Color','Appearance','Specific Gravity','pH','Protein'],
    'Clinical Chemistry': ['Glucose','Cholesterol','Triglycerides','LDL','HDL'],
    'Immunology and Serology': ['Test Type','Result','Antibody/Antigen Level','',''],
    'Microbiology': ['Specimen Type','Organism Isolated','Gram Stain Result','Antibiotic Sensitivity',''],
    'Pathology': ['Specimen Type','Gross Description','Microscopic Findings','Diagnosis/Interpretation','']
  };
  const interpretationLabels = {
    'Hematology': 'Remarks',
    'Clinical Microscopy': 'Microscopy Findings / Remarks',
    'Clinical Chemistry': 'Remarks',
    'Immunology and Serology': 'Remarks',
    'Microbiology': 'Remarks',
    'Pathology': 'Remarks'
  };
  function applyLabels(dept){
    const labels = labelSets[dept] || [];
    const ls = [document.getElementById('label_r1'),document.getElementById('label_r2'),document.getElementById('label_r3'),document.getElementById('label_r4'),document.getElementById('label_r5')];
    const wrappers = document.querySelectorAll('.result-field');
    for(let i=0;i<ls.length;i++){
      const text = labels[i] || '';
      if(ls[i]) ls[i].textContent = text || `Result ${i+1}`;
      if(wrappers[i]) wrappers[i].style.display = text ? '' : 'none';
    }
    const li = document.getElementById('label_interp');
    if(li){ li.textContent = interpretationLabels[dept] || 'Interpretation'; }
  }
  const dept = '{{ v.lab_test_type|default:"" }}';
  if(dept){ applyLabels(dept); }
})();
</script>
{% endblock %}


