{% extends 'base.html' %}
{% block content %}
<h4 class="d-flex align-items-center mb-3">
  <i class="bi bi-list-check text-success me-2"></i>Audit Logs
</h4>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Action Type</label>
        <select class="form-select" name="action">
          <option value="">All Actions</option>
          {% for action in actions %}
            <option value="{{ action }}" {% if action_filter == action %}selected{% endif %}>{{ action }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">User</label>
        <input type="text" class="form-control" name="user" value="{{ user_filter }}" placeholder="Search by username">
      </div>
      <div class="col-md-2">
        <label class="form-label">From Date</label>
        <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">To Date</label>
        <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>Filter
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Audit Logs Table -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>User</th>
            <th>Action</th>
            <th>Details</th>
            <th>IP Address</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td>
                <small>{{ log.timestamp|date:"M d, Y H:i:s" }}</small>
              </td>
              <td>
                {% if log.user %}
                  <strong>{{ log.user.username }}</strong>
                  {% if log.user.is_superuser %}
                    <span class="badge bg-danger ms-1">Superuser</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">System</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-{% if log.action == 'LOGIN' %}success{% elif log.action == 'LOGOUT' %}secondary{% elif 'CREATE' in log.action %}primary{% elif 'UPDATE' in log.action %}warning{% elif 'DELETE' in log.action %}danger{% else %}info{% endif %}">
                  {{ log.get_action_display }}
                </span>
              </td>
              <td>
                <span class="text-break">{{ log.details }}</span>
              </td>
              <td>
                <small class="text-muted">{{ log.ip_address|default:"â€”" }}</small>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">No audit logs found</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    {% if logs.has_other_pages %}
      <nav aria-label="Audit log pagination">
        <ul class="pagination justify-content-center">
          {% if logs.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ logs.previous_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Previous</a>
            </li>
          {% endif %}
          
          {% for num in logs.paginator.page_range %}
            {% if logs.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > logs.number|add:'-3' and num < logs.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if logs.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ logs.next_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Next</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mt-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body text-center">
        <h4>{{ logs.paginator.count }}</h4>
        <p class="mb-0">Total Logs</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <h4>{{ logs|length }}</h4>
        <p class="mb-0">Showing</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <h4>{{ logs|length }}</h4>
        <p class="mb-0">This Page</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body text-center">
        <h4>{{ logs|length }}</h4>
        <p class="mb-0">Filtered</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
