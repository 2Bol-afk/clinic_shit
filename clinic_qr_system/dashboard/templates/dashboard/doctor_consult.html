{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0 d-flex align-items-center"><i class="bi bi-journal-medical text-success me-2"></i>Doctor Consultation</h4>
  <a class="btn btn-outline-secondary" href="/dashboard/doctor/"><i class="bi bi-arrow-left"></i> Back</a>
  </div>


<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2 d-flex align-items-center">Patient Profile <span id="pStep" class="ms-2 small text-success d-none"><i class="bi bi-check-circle-fill"></i></span></h6>
        <div id="pCard" class="small text-muted">
          {% if rec %}
            <div class="fw-semibold">{{ rec.patient.full_name }}</div>
            <div>Age: {{ rec.patient.age }} · ID: {{ rec.patient.id }}</div>
          {% elif draft %}
            <div class="fw-semibold">{{ draft.patient.full_name }}</div>
            <div>Age: {{ draft.patient.age }} · ID: {{ draft.patient.id }}</div>
          {% else %}
            Scan a QR to load patient...
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <form method="post" id="consultForm">
      {% csrf_token %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2 d-flex align-items-center">Patient Symptoms & History <span id="sStep" class="ms-2 small text-success d-none"><i class="bi bi-check-circle-fill"></i></span></h6>
          <label class="form-label">Symptoms</label>
          <textarea name="symptoms" id="symptoms" class="form-control" rows="2">{{ draft.symptoms|default:'' }}</textarea>
          
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2 d-flex align-items-center">Diagnosis <span id="dxStep" class="ms-2 small text-success d-none"><i class="bi bi-check-circle-fill"></i></span></h6>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Primary Diagnosis</label>
              <input class="form-control" name="diagnosis" id="dxPrimary" value="{{ draft.diagnosis|default:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Secondary/Related</label>
              <input class="form-control" id="dxSecondary">
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2 d-flex align-items-center">Medication Prescription <span id="rxStep" class="ms-2 small text-success d-none"><i class="bi bi-check-circle-fill"></i></span></h6>
          <div id="medRows"></div>
          <button class="btn btn-outline-primary btn-sm mt-2" type="button" id="addMed"><i class="bi bi-plus-circle me-1"></i>Add Medicine</button>
          <div class="mt-3">
            <label class="form-label">Prescription Summary</label>
            <textarea class="form-control" id="rxSummary" rows="3" readonly></textarea>
          </div>
          <textarea name="prescription_notes" id="prescription_notes" class="d-none">{{ draft.prescription_notes|default:'' }}</textarea>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2 d-flex align-items-center">Patient Instructions <span id="instStep" class="ms-2 small text-success d-none"><i class="bi bi-check-circle-fill"></i></span></h6>
          <label class="form-label">Instructions</label>
          <textarea class="form-control" id="instructions" rows="2" placeholder="Take after meals; Avoid alcohol; ..."></textarea>
          <div class="row g-2 mt-2">
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="life_diet"><label class="form-check-label" for="life_diet">Diet</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="life_ex"><label class="form-check-label" for="life_ex">Exercise</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="life_rest"><label class="form-check-label" for="life_rest">Rest</label></div></div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" name="status" value="draft" type="submit"><i class="bi bi-save me-1"></i>Save (Not Done)</button>
        <button class="btn btn-success" name="status" value="done" type="submit"><i class="bi bi-check2-circle me-1"></i>Save & Mark Done</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const medRows = document.getElementById('medRows');
  const addMed = document.getElementById('addMed');
  const rxSummary = document.getElementById('rxSummary');
  const rxNotes = document.getElementById('prescription_notes');
  const fields = ['name','dosage','frequency','duration','quantity','instructions'];
  function renderSummary(){
    const rows = medRows.querySelectorAll('.med-row');
    const lines = [];
    rows.forEach((r, index)=>{
      const vals = fields.map(f=> r.querySelector(`[data-med="${f}"]`).value.trim());
      if(vals[0]){ 
        const line = `${vals[0]} — ${vals[1]} — ${vals[2]} — ${vals[3]}${vals[4] ? ` (${vals[4]})` : ''}${vals[5] ? ` - ${vals[5]}` : ''}`;
        lines.push(line);
      }
    });
    const txt = lines.join('\n');
    rxSummary.value = txt;
    rxNotes.value = txt;
    document.getElementById('rxStep').classList.toggle('d-none', !txt);
  }
  function addRow(init){
    const idx = medRows.querySelectorAll('.med-row').length;
    const div = document.createElement('div');
    div.className = 'med-row border rounded p-2 mb-2 bg-white';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Medicine</label>
          <input class="form-control" data-med="name" name="medicine_${idx}_name" value="${(init&&init.name)||''}" placeholder="e.g., Amoxicillin">
        </div>
        <div class="col-md-2">
          <label class="form-label">Dosage</label>
          <input class="form-control" data-med="dosage" name="medicine_${idx}_dosage" value="${(init&&init.dosage)||''}" placeholder="e.g., 500mg">
        </div>
        <div class="col-md-2">
          <label class="form-label">Frequency</label>
          <input class="form-control" data-med="frequency" name="medicine_${idx}_frequency" value="${(init&&init.frequency)||''}" placeholder="e.g., 3x daily">
        </div>
        <div class="col-md-2">
          <label class="form-label">Duration</label>
          <input class="form-control" data-med="duration" name="medicine_${idx}_duration" value="${((init&&init.duration)||'').replace('days','').trim()}" placeholder="e.g., 7 days">
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantity</label>
          <input class="form-control" data-med="quantity" name="medicine_${idx}_quantity" value="${(init&&init.quantity)||''}" placeholder="e.g., 30 tablets">
        </div>
        <div class="col-md-1 text-end">
          <button class="btn btn-outline-danger btn-sm" type="button" data-action="remove"><i class="bi bi-x"></i></button>
        </div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-12">
          <label class="form-label">Special Instructions</label>
          <textarea class="form-control" data-med="instructions" name="medicine_${idx}_instructions" rows="1" placeholder="Special instructions for this medicine">${(init&&init.instructions)||''}</textarea>
        </div>
      </div>`;
    div.addEventListener('input', renderSummary);
    div.addEventListener('click', (e)=>{ if(e.target.closest('[data-action="remove"]')){ div.remove(); renderSummary(); }});
    medRows.appendChild(div);
  }
  addMed.addEventListener('click', ()=> addRow());
  // Prefill from existing prescription notes
  (function prefill(){
    const text = rxNotes.value.trim();
    if(!text) return;
    const lines = text.split('\n');
    lines.forEach(ln=>{
      const parts = ln.split(/\s+[-–—]\s+/);
      if(parts.length >= 4){ addRow({ name: parts[0], dosage: parts[1], frequency: parts[2], duration: parts[3] }); }
    });
    renderSummary();
  })();
  // Step indicators
  document.getElementById('symptoms').addEventListener('input', ()=>{
    document.getElementById('sStep').classList.toggle('d-none', !document.getElementById('symptoms').value.trim());
  });
  document.getElementById('dxPrimary').addEventListener('input', ()=>{
    document.getElementById('dxStep').classList.toggle('d-none', !document.getElementById('dxPrimary').value.trim());
  });
  document.getElementById('instructions').addEventListener('input', ()=>{
    document.getElementById('instStep').classList.toggle('d-none', !document.getElementById('instructions').value.trim());
  });
})();
</script>
{% endblock %}
