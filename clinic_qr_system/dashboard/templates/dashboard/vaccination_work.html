{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Vaccination Workspace Â· {{ visit.patient.full_name }}</h4>
  <a class="btn btn-outline-secondary" href="/dashboard/vaccination/"><i class="bi bi-arrow-left"></i> Back</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          {{ form.vaccine_type.label_tag }}
          {{ form.vaccine_type }}
        </div>
        </div>
      <input type="hidden" name="status" value="{{ vacc_record.status|default:'in_process' }}">
      <div style="display:none;">
        {{ form.details }}
      </div>
      <div class="mt-3">
        <div class="card border-0 border-top">
          <div class="card-body">
            <h6 class="mb-3 d-flex align-items-center"><i class="bi bi-list-check me-2 text-success"></i> Dose Planner</h6>
            <div id="dosePlanner"></div>
          </div>
        </div>
      </div>
      <input type="hidden" name="dose_plan_json" id="dose_plan_json">
      {{ vacc_record.details|json_script:"dose_plan_initial_data" }}
      <div class="mt-3 d-flex gap-2">
        
        <button class="btn btn-success" type="submit" name="action" value="done"><i class="bi bi-check2-circle me-1"></i>Mark Done</button>
        <button class="btn" type="submit" name="action" value="not_done" style="background-color: #6a4c93; color: white; border-color: #6a4c93;"><i class="bi bi-x-circle me-1"></i>Mark Not Done</button>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize vaccination form
    const vaccineTypeSelect = document.getElementById('vaccine_type_select');
    const detailsTextarea = document.querySelector('textarea[name="details"]');
    const dosePlannerEl = document.getElementById('dosePlanner');
    const dosePlanHidden = document.getElementById('dose_plan_json');
    const patientAge = parseInt('{{ visit.patient.age|default:0 }}', 10) || 0;
    const lsKey = 'vacc_dose_plan_visit_{{ visit.id }}';
    const formEl = document.querySelector('form');
    const doneBtn = document.querySelector('button[name="action"][value="done"]');
    
    if (vaccineTypeSelect) {
        console.log('Vaccine type select found:', vaccineTypeSelect);
        console.log('Available options:', vaccineTypeSelect.options.length);
        
        // Add change event listener for dynamic behavior
        vaccineTypeSelect.addEventListener('change', function() {
            console.log('Vaccine type changed to:', this.value);
            updateVaccinationForm(this.value);
        });
        
        // Initialize form on page load
        initWithSavedPlan();
    } else {
        console.error('Vaccine type select not found!');
    }
    
    function updateVaccinationForm(vaccineType) {
        console.log('Updating form for vaccine type:', vaccineType);
        
        // Update details placeholder based on vaccine type
        if (detailsTextarea) {
            switch(vaccineType) {
                case 'COVID-19 Vaccine':
                    detailsTextarea.placeholder = 'COVID-19 vaccination details (dose number, batch, side effects, etc.)';
                    break;
                case 'Influenza (Flu) Vaccine':
                    detailsTextarea.placeholder = 'Influenza vaccination details (season, strain, side effects, etc.)';
                    break;
                case 'Hepatitis B Vaccine':
                    detailsTextarea.placeholder = 'Hepatitis B vaccination details (dose number, schedule, side effects, etc.)';
                    break;
                case 'Tetanus Vaccine':
                    detailsTextarea.placeholder = 'Tetanus vaccination details (booster, wound exposure, side effects, etc.)';
                    break;
                case 'Measles, Mumps, Rubella (MMR) Vaccine':
                    detailsTextarea.placeholder = 'MMR vaccination details (dose number, age, side effects, etc.)';
                    break;
                case 'Polio Vaccine':
                    detailsTextarea.placeholder = 'Polio vaccination details (dose number, schedule, side effects, etc.)';
                    break;
                case 'Varicella (Chickenpox) Vaccine':
                    detailsTextarea.placeholder = 'Varicella vaccination details (dose number, age, side effects, etc.)';
                    break;
                case 'Human Papillomavirus (HPV) Vaccine':
                    detailsTextarea.placeholder = 'HPV vaccination details (dose number, age, side effects, etc.)';
                    break;
                default:
                    detailsTextarea.placeholder = 'Additional vaccination details...';
            }
        }
        
        // Build dose planner UI
        buildDosePlanner(vaccineType, /*suppressInitialSync*/ true);
        // Try to hydrate from saved plan
        hydrateDosePlanner();
    }

    function buildDosePlanner(vaccineType, suppressInitialSync=false) {
        if (!dosePlannerEl) return;
        dosePlannerEl.innerHTML = '';

        const rules = {
            'Influenza (Flu) Vaccine': { baseDoses: 1, boosters: false },
            'COVID-19 Vaccine': { baseDoses: 2, boosters: true },
            'Measles, Mumps, Rubella (MMR) Vaccine': { baseDoses: 2, boosters: false },
            'Varicella (Chickenpox) Vaccine': { baseDoses: 2, boosters: false },
            'Hepatitis B Vaccine': { baseDoses: 3, boosters: false },
            'Human Papillomavirus (HPV) Vaccine': { baseDoses: (patientAge < 15 ? 2 : 3), boosters: false },
            'Polio Vaccine': { baseDoses: 4, boosters: false },
            'Tetanus Vaccine': { baseDoses: 3, boosters: 'tetanus' }
        };

        const cfg = rules[vaccineType];
        if (!cfg) return;

        const container = document.createElement('div');
        container.className = 'row g-2';

        // Primary doses
        for (let i = 1; i <= cfg.baseDoses; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = renderDoseCheckbox(vaccineType, `Dose ${i}`, `dose_${i}`);
            container.appendChild(col);
        }

        // COVID boosters: allow add/remove boosters dynamically
        if (cfg.boosters === true) {
            const boostersWrap = document.createElement('div');
            boostersWrap.className = 'col-12';
            boostersWrap.innerHTML = `
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="addBoosterBtn">
                    <i class="bi bi-plus-lg"></i> Add Booster
                  </button>
                  <div id="boostersList" class="row g-2 mt-1"></div>
                </div>
            `;
            container.appendChild(boostersWrap);

            setTimeout(() => {
                const addBtn = document.getElementById('addBoosterBtn');
                const boostersList = document.getElementById('boostersList');
                if (addBtn && boostersList) {
                    let boosterCount = 0;
                    addBtn.addEventListener('click', () => {
                        boosterCount += 1;
                        const boosterId = `booster_${boosterCount}`;
                        const div = document.createElement('div');
                        div.className = 'col-md-6';
                        div.innerHTML = `
                          <div class="d-flex align-items-start gap-2">
                            <div class="flex-grow-1">${renderDoseCheckbox(vaccineType, `Booster ${boosterCount}`, boosterId, true)}</div>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-booster" data-key="${boosterId}"><i class="bi bi-x"></i></button>
                          </div>
                        `;
                        boostersList.appendChild(div);
                        wireDoseRow(boosterId);
                        syncDosePlan();
                    });
                    boostersList.addEventListener('click', (e) => {
                        const btn = e.target.closest('.remove-booster');
                        if (!btn) return;
                        const key = btn.getAttribute('data-key');
                        const row = btn.closest('.col-md-6');
                        if (row) row.remove();
                        // Remove from localStorage/details on next sync
                        syncDosePlan();
                    });
                }
            }, 0);
        }

        // Tetanus booster checkbox (every 10 years)
        if (cfg.boosters === 'tetanus') {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = renderDoseCheckbox(vaccineType, 'Booster (every 10 years)', 'tetanus_booster');
            container.appendChild(col);
        }

        dosePlannerEl.appendChild(container);

        // Wire up dose rows
        const inputs = dosePlannerEl.querySelectorAll('.dose-checkbox');
        inputs.forEach(inp => wireDoseRow(inp.dataset.key));

        // Initial sync (optional)
        if (!suppressInitialSync) {
            syncDosePlan();
            validateCompletion();
        }
    }

    function renderDoseCheckbox(vaccineType, label, key, isBooster=false) {
        const dateId = `${key}_date`;
        return `
            <div class="form-check align-items-center">
              <input class="form-check-input dose-checkbox" type="checkbox" id="${key}" name="dose[${key}]" value="1" data-key="${key}" data-label="${label}">
              <label class="form-check-label" for="${key}">${label}</label>
            </div>
            <div class="mt-1 ms-4">
              <input type="date" class="form-control form-control-sm dose-date" id="${dateId}" name="date[${key}]" data-key="${key}" style="display:none;" placeholder="YYYY-MM-DD">
            </div>
        `;
    }

    function wireDoseRow(key) {
        const cb = document.getElementById(key);
        const dateInput = document.getElementById(`${key}_date`);
        if (!cb || !dateInput) return;
        cb.addEventListener('change', () => {
            const isSecondOrThird = (key === 'dose_2' || key === 'dose_3');
            const isBooster = (key.startsWith('booster_') || key === 'tetanus_booster');
            const alwaysVisible = isSecondOrThird || isBooster;
            dateInput.style.display = (cb.checked || alwaysVisible) ? 'block' : 'none';
            if (!cb.checked && !alwaysVisible) dateInput.value = '';
            syncDosePlan();
        });
        dateInput.addEventListener('change', syncDosePlan);
        // Allow scheduling for Dose 2/3 and Boosters even if not checked
        if (key === 'dose_2' || key === 'dose_3' || key.startsWith('booster_') || key === 'tetanus_booster') {
            dateInput.style.display = 'block';
        }
    }

    function getCsrfToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : '';
    }

    function syncDosePlan() {
        const plan = { vaccine: vaccineTypeSelect ? vaccineTypeSelect.value : '', doses: [] };
        const rows = dosePlannerEl ? dosePlannerEl.querySelectorAll('.dose-checkbox') : [];
        rows.forEach(cb => {
            const key = cb.dataset.key;
            const label = cb.dataset.label;
            const date = (document.getElementById(`${key}_date`) || {}).value || '';
            plan.doses.push({ key, label, checked: cb.checked, date });
        });
        if (dosePlanHidden) dosePlanHidden.value = JSON.stringify(plan);
        if (detailsTextarea) {
            detailsTextarea.value = JSON.stringify(plan);
        }
        try { localStorage.setItem(lsKey, JSON.stringify(plan)); } catch (e) {}
        validateCompletion();
        // Autosave to server
        try {
            fetch(`/dashboard/vaccination/work/${encodeURIComponent({{ visit.id }})}/autosave/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                },
                credentials: 'same-origin',
                body: JSON.stringify(plan)
            }).catch(() => {});
        } catch (e) {}
    }

    function hydrateDosePlanner() {
        const scriptEl = document.getElementById('dose_plan_initial_data');
        const tryParse = (s) => { try { return JSON.parse(s); } catch (e) { return null; } };
        const isValid = (obj) => obj && typeof obj === 'object' && Array.isArray(obj.doses) && obj.doses.length > 0;
        let source = null;
        // 1) embedded saved JSON (server truth)
        if (scriptEl && scriptEl.textContent) {
            const fromScript = tryParse(scriptEl.textContent);
            if (isValid(fromScript)) source = fromScript;
        }
        // 2) localStorage
        if (!source) {
            const fromLs = (() => { try { return tryParse(localStorage.getItem(lsKey)); } catch(e){ return null; } })();
            if (isValid(fromLs)) source = fromLs;
        }
        // 3) textarea (if it contains a valid plan)
        if (!source && detailsTextarea && detailsTextarea.value) {
            const fromTa = tryParse(detailsTextarea.value);
            if (isValid(fromTa)) source = fromTa;
        }
        if (!isValid(source)) return;
        // Ensure planner is built for saved vaccine type
        if (vaccineTypeSelect && source.vaccine && vaccineTypeSelect.value !== source.vaccine) {
            vaccineTypeSelect.value = source.vaccine;
            buildDosePlanner(source.vaccine, /*suppressInitialSync*/ true);
        }
        // Apply dose checks and dates
        (source.doses || []).forEach(d => {
            const cb = document.getElementById(d.key);
            const dateInput = document.getElementById(`${d.key}_date`);
            if (cb) cb.checked = !!d.checked;
            if (dateInput) {
                const isSecondOrThird = (d.key === 'dose_2' || d.key === 'dose_3');
                const isBooster = (String(d.key).startsWith('booster_') || d.key === 'tetanus_booster');
                const alwaysVisible = isSecondOrThird || isBooster;
                if (d.checked || alwaysVisible) {
                    dateInput.style.display = 'block';
                    if (d.date) dateInput.value = d.date;
                } else {
                    dateInput.style.display = 'none';
                    dateInput.value = '';
                }
            }
        });
        // Ensure hidden fields are synced AFTER hydration
        syncDosePlan();
        validateCompletion();
    }

    function initWithSavedPlan() {
        // Prefer saved plan's vaccine type when initializing
        const scriptEl = document.getElementById('dose_plan_initial_data');
        const tryParse = (s) => { try { return JSON.parse(s); } catch (e) { return null; } };
        const isValid = (obj) => obj && typeof obj === 'object' && Array.isArray(obj.doses) && obj.doses.length > 0;
        let saved = null;
        // localStorage first
        saved = (() => { try { return tryParse(localStorage.getItem(lsKey)); } catch(e){ return null; } })();
        if (!isValid(saved) && scriptEl && scriptEl.textContent) saved = tryParse(scriptEl.textContent);
        if (!isValid(saved) && detailsTextarea && detailsTextarea.value) saved = tryParse(detailsTextarea.value);

        const initialVaccine = (isValid(saved) && saved.vaccine) ? saved.vaccine : (vaccineTypeSelect ? vaccineTypeSelect.value : '');
        updateVaccinationForm(initialVaccine);
    }

    function requiredBaseDosesFor(vaccineType) {
        switch (vaccineType) {
            case 'Influenza (Flu) Vaccine': return 1;
            case 'COVID-19 Vaccine': return 2; // boosters optional
            case 'Measles, Mumps, Rubella (MMR) Vaccine': return 2;
            case 'Varicella (Chickenpox) Vaccine': return 2;
            case 'Hepatitis B Vaccine': return 3;
            case 'Human Papillomavirus (HPV) Vaccine': return (patientAge < 15 ? 2 : 3);
            case 'Polio Vaccine': return 4;
            case 'Tetanus Vaccine': return 3; // primary series; booster optional
            default: return 1;
        }
    }

    function validateCompletion() {
        if (!doneBtn) return;
        const vaccine = vaccineTypeSelect ? vaccineTypeSelect.value : '';
        const required = requiredBaseDosesFor(vaccine);
        let complete = true;
        for (let i = 1; i <= required; i++) {
            const cb = document.getElementById(`dose_${i}`);
            const date = document.getElementById(`dose_${i}_date`);
            if (!cb || !cb.checked) { complete = false; break; }
            if (!date || !date.value) { complete = false; break; }
        }
        doneBtn.disabled = !complete;
        doneBtn.title = complete ? '' : `Complete all required doses (1-${required}) with dates to finish`;
    }

    if (formEl) {
        formEl.addEventListener('submit', function(e) {
            const submitter = (e.submitter || {});
            // Always sync latest plan right before submit
            syncDosePlan();
            if (submitter && submitter.name === 'action' && submitter.value === 'done') {
                validateCompletion();
                if (doneBtn && doneBtn.disabled) {
                    e.preventDefault();
                    alert('Please mark all required doses with dates before finishing.');
                }
            }
        });
    }
});
</script>
{% endblock %}


