{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-pencil-square text-primary me-2"></i>Edit Visit Details</h3>
  <a href="{% url 'dashboard_reception' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Reception
  </a>
</div>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <!-- Patient Info Card -->
        <div class="card bg-light mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">
              <i class="bi bi-person-circle me-2"></i>Patient Information
            </h5>
            <div class="row">
              <div class="col-md-6">
                <strong>Name:</strong> {{ visit.patient.full_name }}
              </div>
              <div class="col-md-6">
                <strong>Patient Code:</strong> {{ visit.patient.patient_code }}
              </div>
              <div class="col-md-6">
                <strong>Arrival Time:</strong> {{ visit.timestamp|date:'H:i' }}
              </div>
              <div class="col-md-6">
                <strong>Queue Number:</strong> 
                {% if visit.queue_number %}
                  {% if visit.department %}
                    C-{{ visit.queue_number }}
                  {% elif visit.notes and 'laboratory' in visit.notes|lower %}
                    L-{{ visit.queue_number }}
                  {% elif visit.notes and 'vaccination' in visit.notes|lower %}
                    V-{{ visit.queue_number }}
                  {% else %}
                    #{{ visit.queue_number }}
                  {% endif %}
                {% else %}
                  <span class="text-muted">Not assigned</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </div>
        {% endif %}
        
        {% if visit.status == 'claimed' or visit.claimed_by %}
          <div class="alert" style="background-color: #e6e6fa; border-color: #d8bfd8; color: #4a4a4a;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>This visit has been claimed</strong> and cannot be edited. 
            {% if visit.claimed_by %}
              Claimed by: {{ visit.claimed_by.get_full_name|default:visit.claimed_by.username }}
            {% endif %}
          </div>
        {% endif %}
        
        <form method="post">
          {% csrf_token %}
          
          <div class="row g-3">
            <div class="col-md-6">
              <label for="{{ form.visit_type.id_for_label }}" class="form-label">
                {{ form.visit_type.label }}
                <span class="text-danger">*</span>
              </label>
              {{ form.visit_type }}
              {% if form.visit_type.errors %}
                <div class="text-danger small">
                  {% for error in form.visit_type.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            
            <div class="col-md-6" id="deptGroup">
              <label for="{{ form.department.id_for_label }}" class="form-label">
                {{ form.department.label }}
              </label>
              {{ form.department }}
              {% if form.department.errors %}
                <div class="text-danger small">
                  {% for error in form.department.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            
          </div>
          
          <div class="mt-4 d-flex gap-2">
            {% if visit.status == 'claimed' or visit.claimed_by %}
              <button type="button" class="btn btn-secondary" disabled>
                <i class="bi bi-lock me-1"></i>Cannot Edit Claimed Visit
              </button>
            {% else %}
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Update Visit
              </button>
            {% endif %}
            <a href="{% url 'dashboard_reception' %}" class="btn btn-outline-secondary">
              <i class="bi bi-x-lg me-1"></i>Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    const visitTypeSel = document.querySelector('select[name="visit_type"]');
    const deptGroup = document.getElementById('deptGroup');
    const deptField = document.querySelector('select[name="department"]');
    function toggleDept(){
      const v = (visitTypeSel?.value || '').toLowerCase();
      const show = v === 'consultation';
      if(deptGroup){ deptGroup.style.display = show ? '' : 'none'; }
      if(deptField){ deptField.disabled = !show; if(!show){ deptField.value = ''; } }
    }
    if(visitTypeSel){
      visitTypeSel.addEventListener('change', toggleDept);
      toggleDept();
    }
  })();
</script>
{% endblock %}
