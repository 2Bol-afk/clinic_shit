{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0 d-flex align-items-center">
    <i class="bi bi-capsule-pill text-success me-2"></i>
    Vaccination Activity Report
  </h4>
  
  
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Start date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">End date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Dose</label>
        <select name="dose" class="form-select">
          <option value="">All</option>
          <option value="dose1" {% if dose_filter == 'dose1' %}selected{% endif %}>1st Dose</option>
          <option value="dose2" {% if dose_filter == 'dose2' %}selected{% endif %}>2nd Dose</option>
          <option value="dose3" {% if dose_filter == 'dose3' %}selected{% endif %}>3rd Dose</option>
          <option value="booster" {% if dose_filter == 'booster' %}selected{% endif %}>Booster</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Vaccine Type</label>
        <select name="vtype" class="form-select">
          <option value="">All</option>
          {% for val,label in vaccine_types %}
            <option value="{{ val }}" {% if vaccine_filter == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel me-1"></i>Filter
        </button>
      </div>
    </form>
  </div>
  <div class="card-footer d-flex gap-2">
    <button type="button" class="btn btn-success btn-sm" onclick="printVaccReport()"><i class="bi bi-printer me-1"></i>Print Report</button>
    <a class="btn btn-outline-danger btn-sm" href="?start_date={{ start_date }}&end_date={{ end_date }}&dose={{ dose_filter }}&vtype={{ vaccine_filter }}&export=pdf"><i class="bi bi-file-earmark-pdf me-1"></i>Export PDF</a>
    <a class="btn btn-outline-primary btn-sm" href="?start_date={{ start_date }}&end_date={{ end_date }}&dose={{ dose_filter }}&vtype={{ vaccine_filter }}&export=csv"><i class="bi bi-filetype-csv me-1"></i>Export CSV</a>
    <a class="btn btn-outline-primary btn-sm" href="?start_date={{ start_date }}&end_date={{ end_date }}&dose={{ dose_filter }}&vtype={{ vaccine_filter }}&export=xlsx"><i class="bi bi-file-earmark-excel me-1"></i>Export XLSX</a>
  </div>
  <div class="card-footer text-muted small">
    Showing records from {{ start_date }} to {{ end_date }}
  </div>
  
</div>

<div id="vaccination-report-print">
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Patient</th>
          <th>Vaccine</th>
          <th>Status</th>
          <th>1st Dose</th>
          <th>2nd Dose</th>
          <th>3rd Dose</th>
          {% if has_booster %}<th>Booster</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for r in records %}
          <tr>
            <td>{{ r.created_at|date:'Y-m-d H:i'|default:'—' }}</td>
            <td>{{ r.visit.patient.full_name|default:'—' }}</td>
            <td>{{ r.get_vaccine_type_display|default:r.visit.vaccine_type|default:'—' }}</td>
            <td>{{ r.get_status_display|default:r.status }}</td>
            <td>
              {% if r.dose1_date %}
                {{ r.dose1_date|date:'Y-m-d' }}
              {% else %}
                {% with doses=r.details.doses %}
                  {% if doses %}
                    {% for d in doses %}
                      {% if d.label %}{% with lbl=d.label|lower %}{% if lbl|slice:":6" == "dose 1" %}{{ d.date }}{% endif %}{% endwith %}{% endif %}
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            <td>
              {% if r.dose2_date %}
                {{ r.dose2_date|date:'Y-m-d' }}
              {% else %}
                {% with doses=r.details.doses %}
                  {% if doses %}
                    {% for d in doses %}
                      {% if d.label %}{% with lbl=d.label|lower %}{% if lbl|slice:":6" == "dose 2" %}{{ d.date }}{% endif %}{% endwith %}{% endif %}
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            <td>
              {% if r.dose3_date %}
                {{ r.dose3_date|date:'Y-m-d' }}
              {% else %}
                {% with doses=r.details.doses %}
                  {% if doses %}
                    {% for d in doses %}
                      {% if d.label %}{% with lbl=d.label|lower %}{% if lbl|slice:":6" == "dose 3" %}{{ d.date }}{% endif %}{% endwith %}{% endif %}
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            {% if has_booster %}
            <td>
              {% if r.booster_date %}
                {{ r.booster_date|date:'Y-m-d' }}
              {% else %}
                {% with doses=r.details.doses %}
                  {% if doses %}
                    {% for d in doses %}
                      {% if d.label %}{% with lbl=d.label|lower %}{% if 'booster' in lbl %}{{ d.date }}{% endif %}{% endwith %}{% endif %}
                    {% endfor %}
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            {% endif %}
          </tr>
        {% empty %}
          <tr>
            <td colspan="{% if has_booster %}8{% else %}7{% endif %}" class="text-center text-muted">No vaccination records found for the selected dates.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function buildPrintableHtml(inner){
  return `<!doctype html><html><head><meta charset="utf-8"><title>Vaccination Report</title><style>body{font-family:Arial} .print-table{width:100%;border-collapse:collapse;font-size:12px} .print-table th,.print-table td{border:1px solid #000;padding:4px;text-align:left} .print-table th{background:#f0f0f0}</style></head><body>${inner}</body></html>`;
}
function printVaccReport(){
  const src = document.getElementById('vaccination-report-print');
  const html = buildPrintableHtml(src ? src.outerHTML : document.body.innerHTML);
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';iframe.style.right='0';iframe.style.bottom='0';iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';
  document.body.appendChild(iframe);
  const doc = iframe.contentWindow || iframe.contentDocument; const idoc = doc.document || doc; idoc.open(); idoc.write(html); idoc.close();
  const cleanup=()=>{try{document.body.removeChild(iframe);}catch(_){}};
  iframe.onload=function(){try{(iframe.contentWindow||iframe).focus();(iframe.contentWindow||iframe).print();}catch(_){}};
  setTimeout(()=>{try{(iframe.contentWindow||iframe).focus();(iframe.contentWindow||iframe).print();}catch(_){}} ,300);
  const w = iframe.contentWindow || iframe; if(w){ w.onafterprint = cleanup; }
  setTimeout(cleanup,5000);
}
</script>

{% endblock %}


