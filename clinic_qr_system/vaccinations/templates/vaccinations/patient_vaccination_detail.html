{% extends 'vaccinations/base.html' %}

{% block page_title %}{{ vaccination.patient.full_name }} - {{ vaccination.vaccine_type.name }}{% endblock %}

{% block page_actions %}
<a href="{% url 'vaccinations:patient_vaccination_list' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to List
</a>
{% if not vaccination.completed %}
    <a href="{% url 'vaccinations:administer_dose' vaccination.doses.first.pk %}" class="btn btn-success">
        <i class="fas fa-syringe"></i> Administer Next Dose
    </a>
{% endif %}
{% endblock %}

{% block page_content %}
<div class="row">
    <!-- Patient Information -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Patient Information</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    {% if vaccination.patient.profile_photo %}
                        <img src="{{ vaccination.patient.profile_photo.url }}" 
                             class="rounded-circle" width="80" height="80" alt="Profile Photo">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                             style="width: 80px; height: 80px; margin: 0 auto;">
                            <i class="fas fa-user fa-2x text-white"></i>
                        </div>
                    {% endif %}
                </div>
                <h5 class="text-center">{{ vaccination.patient.full_name }}</h5>
                <p class="text-center text-muted">{{ vaccination.patient.patient_code }}</p>
                
                <hr>
                
                <div class="row">
                    <div class="col-6">
                        <strong>Age:</strong><br>
                        <span class="text-muted">{{ vaccination.patient.age }} years</span>
                    </div>
                    <div class="col-6">
                        <strong>Contact:</strong><br>
                        <span class="text-muted">{{ vaccination.patient.contact }}</span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <strong>Email:</strong><br>
                    <span class="text-muted">{{ vaccination.patient.email }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vaccination Details -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Vaccination Details</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Vaccine Type:</strong><br>
                        <span class="text-muted">{{ vaccination.vaccine_type.name }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Total Doses Required:</strong><br>
                        <span class="badge bg-info">{{ vaccination.vaccine_type.total_doses_required }}</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Started Date:</strong><br>
                        <span class="text-muted">{{ vaccination.started_date }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong><br>
                        {% if vaccination.completed %}
                            <span class="badge bg-success">Completed</span>
                        {% elif vaccination.is_overdue %}
                            <span class="badge bg-danger">Overdue</span>
                        {% else %}
                            <span class="badge bg-warning">In Progress</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if vaccination.completed %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Completion Date:</strong><br>
                        <span class="text-muted">{{ vaccination.completion_date }}</span>
                    </div>
                </div>
                {% endif %}
                
                <!-- Progress Bar -->
                <div class="mb-3">
                    <strong>Progress:</strong>
                    <div class="progress mt-2" style="height: 25px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ vaccination.get_completion_percentage }}%">
                            {{ vaccination.get_completion_percentage|floatformat:0 }}%
                        </div>
                    </div>
                </div>
                
                {% if vaccination.notes %}
                <div class="mb-3">
                    <strong>Notes:</strong><br>
                    <span class="text-muted">{{ vaccination.notes }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Dose Schedule -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Dose Schedule</h6>
            </div>
            <div class="card-body">
                {% if doses %}
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Dose #</th>
                                    <th>Scheduled Date</th>
                                    <th>Administered Date</th>
                                    <th>Status</th>
                                    
                                    <th>Site of Injection</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dose in doses %}
                                <tr class="{% if dose.administered %}table-success{% elif dose.is_overdue %}table-danger{% endif %}">
                                    <td>
                                        <strong>{{ dose.dose_number }}</strong>
                                    </td>
                                    <td>{{ dose.scheduled_date }}</td>
                                    <td>
                                        {% if dose.administered_date %}
                                            {{ dose.administered_date }}
                                        {% else %}
                                            <span class="text-muted">Not administered</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if dose.administered %}
                                            <span class="badge bg-success">Administered</span>
                                        {% elif dose.is_overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% elif dose.can_be_administered %}
                                            <span class="badge bg-warning">Ready</span>
                                        {% else %}
                                            <span class="badge bg-info">Scheduled</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        {% if dose.site_of_injection %}
                                            {{ dose.site_of_injection }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if dose.administered %}
                                            <span class="text-muted">Completed</span>
                                        {% elif dose.can_be_administered %}
                                            <a href="{% url 'vaccinations:administer_dose' dose.pk %}" 
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-syringe"></i> Administer
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Not yet due</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No doses scheduled</h5>
                        <p class="text-muted">This vaccination doesn't have any doses scheduled yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Adverse Reactions -->
{% if doses %}
    {% for dose in doses %}
        {% if dose.adverse_reactions %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="m-0 font-weight-bold">Adverse Reactions - Dose {{ dose.dose_number }}</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">{{ dose.adverse_reactions }}</p>
                        {% if dose.notes %}
                            <hr>
                            <strong>Additional Notes:</strong><br>
                            <span class="text-muted">{{ dose.notes }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% endif %}
{% endblock %}
