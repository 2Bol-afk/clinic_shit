{% extends 'base.html' %}

{% block content %}
<style>
  .main-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem 0;
  }
  
  .qr-scanner-section {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 0.5rem 2rem rgba(0,0,0,.1);
    padding: 3rem 2rem;
    text-align: center;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
  }
  
  .qr-scan-button {
    background: linear-gradient(135deg, #198754, #157347);
    border: none;
    border-radius: 1rem;
    padding: 1.5rem 3rem;
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 0.5rem 1rem rgba(25,135,84,.3);
    display: inline-flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    cursor: pointer;
  }
  
  .qr-scan-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.8rem 1.5rem rgba(25,135,84,.4);
    color: white;
    text-decoration: none;
  }
  
  .qr-scan-button:active {
    transform: translateY(0);
  }
  
  .qr-icon {
    font-size: 2rem;
  }
  
  .divider {
    margin: 2rem 0;
    text-align: center;
    position: relative;
  }
  
  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #dee2e6;
  }
  
  .divider span {
    background: white;
    padding: 0 1rem;
    color: #6c757d;
    font-size: 0.9rem;
  }
  
  .email-input-section {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.1);
    border: 1px solid #e9ecef;
  }
  
  .form-control {
    border-radius: 0.75rem;
    border: 2px solid #e9ecef;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  .form-control:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25,135,84,.25);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #198754, #157347);
    border: none;
    border-radius: 0.75rem;
    padding: 1rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.5rem 1rem rgba(25,135,84,.3);
  }
  
  .patient-info-card {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 0.5rem 2rem rgba(0,0,0,.1);
    padding: 2rem;
    margin-top: 2rem;
    display: none;
    border: 1px solid #e9ecef;
  }
  
  .patient-info-card.show {
    display: block;
    animation: slideIn 0.5s ease;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .dashboard-section {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
  }
  
  .dashboard-section:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
  }
  
  .section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f8f9fa;
  }
  
  .section-icon {
    font-size: 1.5rem;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #198754, #157347);
    color: white;
  }
  
  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .status-normal { background: #d1edff; color: #0c63e4; }
  .status-warning { background: #e6e6fa; color: #4a4a4a; }
  .status-danger { background: #f8d7da; color: #721c24; }
  
  .timeline-item {
    border-left: 3px solid #e9ecef;
    padding-left: 1rem;
    margin-bottom: 1rem;
    position: relative;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 0.5rem;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: #198754;
  }
  .timeline-item:last-child {
    border-left: none;
  }
  
  /* Patient details styling */
  .patient-details {
    max-width: 500px;
    margin: 0 auto;
  }
  
  .detail-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8f9fa;
  }
  
  .detail-item:last-child {
    border-bottom: none;
  }
  
  .detail-item i {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
  }
</style>

<div class="main-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Header -->
        <div class="text-center mb-5">
          <h1 class="display-5 fw-bold text-dark mb-3">
            <i class="bi bi-qr-code-scan me-3 text-success"></i>Patient Quick Scan
          </h1>
          <p class="lead text-muted">Scan your QR code or enter your email to access your medical records</p>
        </div>

        <!-- QR Scanner Section -->
        <div class="qr-scanner-section">
          <h2 class="h4 fw-bold text-dark mb-3">Quick Access Portal</h2>
          <p class="text-muted mb-4">Use your phone camera to scan the QR code for instant access</p>
          
          <button type="button" class="qr-scan-button qr-scan-btn" data-intent="patient" data-bs-toggle="modal" data-bs-target="#qrScannerModal">
            <i class="bi bi-camera qr-icon"></i>
            <span>Scan QR Code</span>
          </button>
        </div>
        
        <!-- Divider -->
        <div class="divider">
          <span>OR</span>
        </div>
        
        <!-- Email Input Section -->
        <div class="email-input-section">
          <h3 class="h5 fw-semibold text-dark mb-3">Enter Email Manually</h3>
          <form id="qrLoginForm" method="post">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-8">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                  <input type="email" name="email" class="form-control" 
                         placeholder="Enter your registered Gmail address" required autofocus>
                </div>
                <div class="form-text mt-2">
                  <i class="bi bi-info-circle me-1"></i>
                  Your email is linked to your patient records for secure access
                </div>
              </div>
              <div class="col-md-4">
                <button class="btn btn-primary w-100" type="submit">
                  <i class="bi bi-search me-2"></i>Load Dashboard
                </button>
              </div>
            </div>
          </form>

          {% if error %}
            <div class="alert alert-danger mt-3" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
            </div>
          {% endif %}
        </div>

        <!-- Patient Information Display (Initially Hidden) -->
        <div id="patientInfoCard" class="patient-info-card">
          <!-- Profile Picture at Top -->
          <div class="text-center mb-4">
            <div id="patientQR" class="mb-3">
              <!-- Profile photo will be inserted here -->
            </div>
          </div>
          
          <!-- Patient Details - Vertical Layout -->
          <div class="patient-details">
            <!-- Full Name -->
            <div class="detail-item mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-person-circle me-3 text-primary"></i>
                <div>
                  <small class="text-muted d-block">Full Name</small>
                  <span id="patientName" class="fw-bold text-dark">Loading...</span>
                </div>
              </div>
            </div>
            
            <!-- Patient ID -->
            <div class="detail-item mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-card-text me-3 text-primary"></i>
                <div>
                  <small class="text-muted d-block">Patient ID</small>
                  <span id="patientCode" class="fw-bold text-primary">Loading...</span>
                </div>
              </div>
            </div>
            
            <!-- Email Address -->
            <div class="detail-item mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-envelope me-3 text-primary"></i>
                <div>
                  <small class="text-muted d-block">Email Address</small>
                  <span id="patientEmail" class="fw-semibold text-dark">Loading...</span>
                </div>
              </div>
            </div>
            
            <!-- Verification Status -->
            <div class="detail-item mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-shield-check me-3 text-primary"></i>
                <div>
                  <small class="text-muted d-block">Verification Status</small>
                  <span class="fw-semibold text-success">Verified Patient</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Active Consultation Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-clipboard-pulse"></i>
              </div>
              <h3 class="section-title">Active Consultation</h3>
            </div>
            <div id="activeConsultation">
              <div class="text-center text-muted py-4">
                <i class="bi bi-clipboard-x fs-1 mb-3"></i>
                <p class="mb-0">No active consultation</p>
              </div>
            </div>
          </div>

          <!-- Medical History Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-clock-history"></i>
              </div>
              <h3 class="section-title">Medical History</h3>
            </div>
            <div id="medicalHistory">
              <div class="text-center text-muted py-4">
                <i class="bi bi-journal-x fs-1 mb-3"></i>
                <p class="mb-0">No medical history available</p>
              </div>
            </div>
          </div>

          <!-- Lab Results Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-droplet"></i>
              </div>
              <h3 class="section-title">Laboratory Results</h3>
            </div>
            <div id="labResults">
              <div class="text-center text-muted py-4">
                <i class="bi bi-flask fs-1 mb-3"></i>
                <p class="mb-0">No lab results available</p>
              </div>
            </div>
          </div>

          <!-- Prescriptions Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-capsule"></i>
              </div>
              <h3 class="section-title">Prescriptions & Medications</h3>
            </div>
            <div id="prescriptions">
              <div class="text-center text-muted py-4">
                <i class="bi bi-capsule fs-1 mb-3"></i>
                <p class="mb-0">No active prescriptions</p>
              </div>
            </div>
          </div>

          <!-- Appointments Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-calendar-check"></i>
              </div>
              <h3 class="section-title">Appointments & Follow-Ups</h3>
            </div>
            <div id="appointments">
              <div class="text-center text-muted py-4">
                <i class="bi bi-calendar-x fs-1 mb-3"></i>
                <p class="mb-0">No upcoming appointments</p>
              </div>
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="dashboard-section">
            <div class="section-header">
              <div class="section-icon">
                <i class="bi bi-graph-up"></i>
              </div>
              <h3 class="section-title">Activity Timeline</h3>
            </div>
            <div id="timeline">
              <div class="text-center text-muted py-4">
                <i class="bi bi-clock-history fs-1 mb-3"></i>
                <p class="mb-0">No activity recorded</p>
              </div>
            </div>
          </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
          <button class="btn btn-success btn-lg me-3" onclick="loginAsPatient()">
            <i class="bi bi-box-arrow-in-right me-2"></i>Access Full Dashboard
          </button>
          <button class="btn btn-outline-secondary" onclick="resetScanner()">
            <i class="bi bi-arrow-clockwise me-2"></i>Scan Another Patient
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger" id="errorModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>Error
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
        </div>
        <p id="errorModalMessage" class="mb-0"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-success" id="successModalLabel">
          <i class="bi bi-check-circle me-2"></i>Success
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        </div>
        <p id="successModalMessage" class="mb-0"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continue</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentPatientData = null;

// Handle form submission
document.getElementById('qrLoginForm').addEventListener('submit', function(e) {
  // Check if this is a proceed button submission (allow it to proceed)
  const proceedButton = document.getElementById('proceedToDashboardBtn');
  if (proceedButton && proceedButton.disabled) {
    // This is a proceed submission, allow it to continue
    return;
  }
  
  e.preventDefault();
  const email = this.querySelector('input[name="email"]').value.trim();
  if (!email) return;
  
  // Use the same validation and auto-login flow as QR scan
  handleEmailForPatient(email);
});

// Function to handle email validation and auto-login for patients
function handleEmailForPatient(email) {
  const e = email.trim();
  if (!e) return;
  
  // Load patient data and display info container first
  loadPatientData(e);
}

// Global callback for patient QR scans
window.handlePatientQRCallback = function(email) {
  handleEmailForPatient(email);
};

// Load patient data via API
async function loadPatientData(email) {
  // Clear any existing errors first
  clearErrors();
  
  // Basic email format validation
  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  if (!emailPattern.test(email)) {
    showError('Invalid email format. Please scan a valid QR code or use a registered email address.');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('email', email);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    const response = await fetch('/patients/api/qr-scan/', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentPatientData = data;
      displayPatientInfo(data);
      showSuccessMessage(data.patient.full_name, data.patient.email);
    } else {
      // Handle different error types
      if (data.error_type === 'invalid_format') {
        showError('Invalid email format. Please scan a valid QR code or use a registered email address.');
      } else if (data.error_type === 'not_found') {
        showError('Patient not found. Please scan a valid QR code or use a registered email address.');
      } else {
        showError(data.error || 'Patient not found. Please scan a valid QR code or use a registered email address.');
      }
    }
  } catch (error) {
    showError('Error loading patient data. Please try again.');
    console.error('Error:', error);
  }
}

// Display patient information
function displayPatientInfo(data) {
  const patient = data.patient;
  
  // Update patient info with highlighting
  const nameElement = document.getElementById('patientName');
  const emailElement = document.getElementById('patientEmail');
  
  nameElement.innerHTML = `<span class="text-success fw-bold">${patient.full_name}</span>`;
  document.getElementById('patientCode').textContent = patient.patient_code;
  emailElement.innerHTML = `<span class="text-primary fw-bold">${patient.email}</span>`;
  
  // Add validation badge
  const validationBadge = document.createElement('div');
  validationBadge.className = 'alert alert-success mt-2 mb-0';
  validationBadge.innerHTML = '<i class="bi bi-shield-check me-2"></i><strong>Verified Patient</strong>';
  
  // Insert validation badge after patient info
  const patientInfoCard = document.querySelector('.patient-info-card');
  if (patientInfoCard && !patientInfoCard.querySelector('.alert-success')) {
    patientInfoCard.insertBefore(validationBadge, patientInfoCard.firstChild);
  }
  
  // Show profile photo and QR code
  const qrContainer = document.getElementById('patientQR');
  let qrHtml = '';
  
  // Always show profile photo if available
  if (patient.profile_photo_url) {
    qrHtml = `
      <div class="d-flex align-items-center justify-content-center mb-3">
        <img src="${patient.profile_photo_url}" 
             class="rounded-circle me-3" 
             style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #28a745;" 
             alt="Profile Photo">
        <div class="text-start">
          <div class="fw-bold text-success">${patient.full_name}</div>
          <div class="small text-muted">${patient.patient_code}</div>
          <div class="small text-muted">${patient.age} years old</div>
        </div>
      </div>
    `;
  } else {
    qrHtml = `
      <div class="d-flex align-items-center justify-content-center mb-3">
        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" 
             style="width: 80px; height: 80px; border: 3px solid #28a745;">
          <i class="bi bi-person-fill text-muted fs-2"></i>
        </div>
        <div class="text-start">
          <div class="fw-bold text-success">${patient.full_name}</div>
          <div class="small text-muted">${patient.patient_code}</div>
          <div class="small text-muted">${patient.age} years old</div>
        </div>
      </div>
    `;
  }
  
  // Add QR code if available
  if (patient.qr_code_url) {
    qrHtml += `<img src="${patient.qr_code_url}" class="img-fluid" style="max-width: 120px;" alt="Patient QR Code">`;
  } else {
    qrHtml += '<div class="text-muted"><i class="bi bi-qr-code fs-4"></i><br><small>QR Code not available</small></div>';
  }
  
  qrContainer.innerHTML = qrHtml;
  
  // Update latest consultation
  const consultationDiv = document.getElementById('latestConsultation');
  if (data.latest_doctor) {
    const doctor = data.latest_doctor;
    consultationDiv.innerHTML = `
      <p class="mb-1"><strong>Diagnosis:</strong> ${doctor.diagnosis || 'Not specified'}</p>
      <p class="mb-1"><strong>Prescription:</strong> ${doctor.prescription_notes || 'None'}</p>
      <small class="text-muted">${new Date(doctor.timestamp).toLocaleDateString()}</small>
    `;
  } else {
    consultationDiv.innerHTML = '<p class="text-muted mb-2">No recent consultations</p>';
  }
  
  // Update recent prescriptions
  const prescriptionsDiv = document.getElementById('recentPrescriptions');
  if (data.latest_pharmacy) {
    const pharmacy = data.latest_pharmacy;
    prescriptionsDiv.innerHTML = `
      <p class="mb-1"><strong>Medicines:</strong> ${pharmacy.medicines || 'None'}</p>
      <small class="text-muted">${new Date(pharmacy.timestamp).toLocaleDateString()}</small>
    `;
  } else {
    prescriptionsDiv.innerHTML = '<p class="text-muted mb-2">No recent prescriptions</p>';
  }
  
  // Update medical history
  const historyDiv = document.getElementById('medicalHistory');
  if (data.visits && data.visits.length > 0) {
    historyDiv.innerHTML = data.visits.map(visit => `
      <div class="timeline-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${visit.service}</h6>
            <p class="mb-1 text-muted">${visit.notes || 'No notes'}</p>
            ${visit.diagnosis ? `<p class="mb-1"><strong>Diagnosis:</strong> ${visit.diagnosis}</p>` : ''}
            ${visit.prescription_notes ? `<p class="mb-1"><strong>Prescription:</strong> ${visit.prescription_notes}</p>` : ''}
          </div>
          <small class="text-muted">${new Date(visit.timestamp).toLocaleDateString()}</small>
        </div>
      </div>
    `).join('');
  } else {
    historyDiv.innerHTML = '<p class="text-muted">No medical history available</p>';
  }
  
  // Update prescriptions list
  const prescriptionsListDiv = document.getElementById('prescriptionsList');
  const doctorVisits = data.visits.filter(v => v.service === 'Doctor Consultation');
  if (doctorVisits.length > 0) {
    prescriptionsListDiv.innerHTML = doctorVisits.map(visit => `
      <div class="card border-0 bg-light mb-3">
        <div class="card-body">
          <h6 class="fw-semibold">${new Date(visit.timestamp).toLocaleDateString()}</h6>
          <p class="mb-1"><strong>Diagnosis:</strong> ${visit.diagnosis || 'Not specified'}</p>
          <p class="mb-0"><strong>Prescription:</strong> ${visit.prescription_notes || 'None'}</p>
        </div>
      </div>
    `).join('');
  } else {
    prescriptionsListDiv.innerHTML = '<p class="text-muted">No prescriptions available</p>';
  }
  
  // Add current visit/queue status if available
  updateCurrentVisitStatus(data);
  
  // Add proceed to dashboard button
  addProceedButton(data);
  
  // Show the patient info card
  document.getElementById('patientInfoCard').classList.add('show');
  
  // Scroll to patient info
  document.getElementById('patientInfoCard').scrollIntoView({ behavior: 'smooth' });
}

// Update current visit/queue status
function updateCurrentVisitStatus(data) {
  const patient = data.patient;
  
  // Check for current visits (not completed)
  const currentVisits = data.visits.filter(v => v.status !== 'done' && v.status !== 'completed');
  
  let statusHtml = '';
  if (currentVisits.length > 0) {
    const latestVisit = currentVisits[0];
    const statusClass = getStatusClass(latestVisit.status);
    statusHtml = `
      <div class="alert alert-info mt-3">
        <h6 class="mb-2"><i class="bi bi-clock-history me-2"></i>Current Visit Status</h6>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>Service:</strong> ${latestVisit.service}<br>
            <strong>Status:</strong> <span class="badge ${statusClass}">${getStatusText(latestVisit.status)}</span>
            ${latestVisit.queue_number ? `<br><strong>Queue #:</strong> ${latestVisit.queue_number}` : ''}
          </div>
          <div class="text-end">
            <small class="text-muted">${new Date(latestVisit.timestamp).toLocaleDateString()}</small>
          </div>
        </div>
      </div>
    `;
  } else {
    statusHtml = `
      <div class="alert alert-light mt-3">
        <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Current Status</h6>
        <p class="mb-0">No active visits. Ready for new consultation.</p>
      </div>
    `;
  }
  
  // Insert status after patient profile section
  const patientProfileSection = document.querySelector('.dashboard-section');
  if (patientProfileSection && !patientProfileSection.querySelector('.alert-info, .alert-light')) {
    patientProfileSection.insertAdjacentHTML('afterend', statusHtml);
  }
}

// Get status class for styling
function getStatusClass(status) {
  switch(status) {
    case 'queued': return 'bg-secondary';
    case 'claimed': return 'bg-warning text-dark';
    case 'in_process': return 'bg-info';
    case 'ready': return 'bg-primary';
    case 'done': return 'bg-success';
    default: return 'bg-secondary';
  }
}

// Get status text for display
function getStatusText(status) {
  switch(status) {
    case 'queued': return 'Queued';
    case 'claimed': return 'Claimed';
    case 'in_process': return 'In Process';
    case 'ready': return 'Ready';
    case 'done': return 'Done';
    default: return status;
  }
}

// Add proceed to dashboard button
function addProceedButton(data) {
  const patient = data.patient;
  
  // Remove existing proceed button if any
  const existingButton = document.getElementById('proceedToDashboardBtn');
  if (existingButton) {
    existingButton.remove();
  }
  
  const buttonHtml = `
    <div class="text-center mt-4 mb-3">
      <button id="proceedToDashboardBtn" class="btn btn-success btn-lg px-5" onclick="proceedToDashboard('${patient.email}')">
        <i class="bi bi-arrow-right-circle me-2"></i>Proceed to Dashboard
      </button>
      <div class="mt-2">
        <small class="text-muted">Click to access your complete medical records and dashboard</small>
      </div>
    </div>
  `;
  
  // Insert button at the end of patient info card
  const patientInfoCard = document.getElementById('patientInfoCard');
  if (patientInfoCard) {
    patientInfoCard.insertAdjacentHTML('beforeend', buttonHtml);
  }
}

// Proceed to dashboard function
function proceedToDashboard(email) {
  // Show loading state
  const button = document.getElementById('proceedToDashboardBtn');
  if (button) {
    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Loading Dashboard...';
    button.disabled = true;
  }
  
  // Ensure the email is set in the form
  const form = document.getElementById('qrLoginForm');
  const emailInput = form.querySelector('input[name="email"]');
  if (emailInput) {
    emailInput.value = email;
  }
  
  // Submit the form to proceed to dashboard
  if (form) {
    // Remove the event listener temporarily to allow form submission
    const formClone = form.cloneNode(true);
    form.parentNode.replaceChild(formClone, form);
    formClone.submit();
  } else {
    // Fallback: redirect to dashboard with email
    window.location.href = `/patients/portal/?email=${encodeURIComponent(email)}`;
  }
}

// Login as patient
function loginAsPatient() {
  if (currentPatientData && currentPatientData.patient.email) {
    // Submit the form with the patient's email
    const form = document.getElementById('qrLoginForm');
    form.querySelector('input[name="email"]').value = currentPatientData.patient.email;
    form.submit();
  }
}

// Reset scanner
function resetScanner() {
  document.getElementById('patientInfoCard').classList.remove('show');
  document.getElementById('qrLoginForm').reset();
  currentPatientData = null;
  document.querySelector('input[name="email"]').focus();
}

// Clear all alert messages
function clearErrors() {
  // Remove existing error and success messages
  const existingAlerts = document.querySelectorAll('.alert-danger, .alert-success');
  existingAlerts.forEach(el => el.remove());
}

// Show error message using modal
function showError(message) {
  clearErrors();
  
  // Show error modal
  const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
  document.getElementById('errorModalMessage').textContent = message;
  errorModal.show();
}

// Show success message using modal
function showSuccessMessage(message, patientName = '', patientEmail = '') {
  clearErrors();
  
  // Show success modal
  const successModal = new bootstrap.Modal(document.getElementById('successModal'));
  let modalText = message;
  if (patientName && patientEmail) {
    modalText += `\n\nPatient: ${patientName}\nEmail: ${patientEmail}`;
  }
  document.getElementById('successModalMessage').textContent = modalText;
  successModal.show();
}

// Show QR scanner error
function showQRScannerError(message) {
  const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
  document.getElementById('errorModalMessage').textContent = message;
  errorModal.show();
}

// Focus on email input when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Check if email is passed as URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const emailParam = urlParams.get('email');
  
  if (emailParam) {
    // Auto-fill and process the email
    document.querySelector('input[name="email"]').value = emailParam;
    handleEmailForPatient(emailParam);
  } else {
    document.querySelector('input[name="email"]').focus();
  }
});
</script>
{% endblock %}
